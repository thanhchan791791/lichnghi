<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Tính Chi Tiêu Tối Thiểu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-teal': '#14b8a6', // Màu xanh ngọc chủ đạo
                        'secondary-blue': '#3b82f6', // Màu xanh dương phụ
                        'bg-light': '#f7f9fc',
                        'card-light': '#ffffff',
                        'profit': '#10b981', // Màu xanh lá cho dư
                        'deficit': '#ef4444', // Màu đỏ cho thâm hụt
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Định nghĩa font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* Đảm bảo toàn bộ ứng dụng chiếm hết chiều cao màn hình và cuộn mượt mà */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
            padding-bottom: 6rem; /* Khoảng trống cuối trang */
        }
        
        /* Hiệu ứng trượt nhẹ nhàng cho các phần tử */
        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Tăng tính thẩm mỹ cho các thẻ input, giống app iOS */
        input:focus, select:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(20, 184, 166, 0.5); /* Primary Teal Focus */
            border-color: #14b8a6;
        }

        /* Cuốn hút hơn cho kết quả */
        .result-card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        .result-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }
        
        /* Hiệu ứng xóa mượt mà */
        .expense-item {
            transition: all 0.3s ease;
        }

        /* Màu nền cho mobile app style */
        .app-container {
            max-width: 420px; /* Giới hạn chiều rộng giống mobile */
            margin: 0 auto;
            min-height: 100vh;
            background-color: #ffffff;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        /* Style cho iframe quản lý số dư */
        #balanceManagerOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 50;
            display: none;
        }
        #balanceIframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body class="bg-bg-light">

    <div id="balanceManagerOverlay">
        <button id="closeBalanceBtn" class="fixed top-4 left-4 z-[60] bg-white/80 backdrop-blur-md p-2 rounded-full shadow-lg border border-gray-200 flex items-center gap-2 px-4 font-medium text-gray-700 hover:bg-gray-100 active:scale-95 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Quay lại
        </button>
        <iframe id="balanceIframe" src=""></iframe>
    </div>

    <div id="app" class="app-container">

        <header class="p-6 bg-primary-teal text-white shadow-lg rounded-b-xl">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-2xl font-bold">Quản Lý Chi Tiêu</h1>
                    <p class="text-sm opacity-90 mt-1">Tính toán mức chi tiêu tối thiểu.</p>
                </div>
                <button id="openBalanceBtn" class="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition-colors border border-white/30 flex flex-col items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a2 2 0 002-2V5a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span class="text-[10px] mt-1 font-bold">SỐ DƯ</span>
                </button>
            </div>
        </header>

        <section class="p-4 mt-6 bg-card-light rounded-2xl shadow-md mx-4 fade-in" style="animation-delay: 0.1s;">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">Tổng Quan Ngân Sách Hàng Tháng</h2>
            
            <div class="mb-4">
                <label for="monthlyRevenue" class="block text-sm font-medium text-gray-600">Tổng Doanh Thu Tháng (VNĐ)</label>
                <input type="number" id="monthlyRevenue" placeholder="Nhập tổng thu nhập" min="0" value="0"
                       class="mt-1 block w-full px-3 py-2 text-xl border border-gray-300 rounded-lg shadow-sm">
            </div>

            <div class="grid grid-cols-2 gap-4">
                
                <div class="result-card bg-bg-light p-4 rounded-xl border border-secondary-blue/50">
                    <p class="text-sm font-medium text-secondary-blue">Chi Phí Cố Định</p>
                    <p id="monthlyResult" class="text-xl font-bold mt-1 text-gray-800">0 VNĐ</p>
                    <p class="text-xs text-gray-400">($ / 30.44 ngày)</p>
                </div>

                <div class="result-card bg-bg-light p-4 rounded-xl border border-gray-200">
                    <p class="text-sm font-medium text-gray-600">Dư / Thâm Hụt</p>
                    <p id="budgetBalance" class="text-xl font-bold mt-1">0 VNĐ</p>
                    <p class="text-xs text-gray-400">(= Thu - Chi)</p>
                </div>
            </div>
            
            <div class="mt-4 pt-3 border-t border-gray-100 text-center">
                <p class="text-sm text-gray-600 font-medium">Tương đương Chi Phí Hàng Ngày</p>
                <p id="dailyResult" class="text-base font-bold text-primary-teal mt-0.5">0 VNĐ</p>
            </div>
        </section>

        <section class="p-4 mt-6 bg-card-light rounded-2xl shadow-md mx-4 fade-in" style="animation-delay: 0.2s;">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">Thêm Khoản Chi Cố Định</h2>
            <form id="expenseForm" class="space-y-3">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-600">Tên Khoản Chi</label>
                    <input type="text" id="name" required placeholder="Ví dụ: Tiền Nhà, Nghĩa Vụ..."
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm">
                </div>
                
                <div>
                    <label for="cost" class="block text-sm font-medium text-gray-600">Chi Phí (VNĐ)</label>
                    <input type="number" id="cost" required placeholder="3000000" min="1"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm">
                </div>

                <div>
                    <label for="frequencyUnit" class="block text-sm font-medium text-gray-600">Tần Suất</label>
                    <select id="frequencyUnit" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm appearance-none bg-white">
                        <option value="monthly">Hàng tháng</option>
                        <option value="yearly">Hàng năm</option>
                        <option value="weekly">Hàng tuần</option>
                        <option value="daily">Hàng ngày</option>
                        <option value="x_days">Mỗi X ngày</option>
                    </select>
                </div>
                
                <div id="xDaysInputContainer" class="hidden">
                    <label for="frequencyValue" class="block text-sm font-medium text-gray-600">Giá trị X (số ngày)</label>
                    <input type="number" id="frequencyValue" placeholder="3 (Mỗi 3 ngày)" min="1" value="1"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm">
                </div>

                <button type="submit"
                        class="w-full mt-4 py-3 bg-secondary-blue text-white font-semibold rounded-xl shadow-lg hover:bg-blue-600 transition duration-150 transform hover:scale-[1.01] active:scale-95">
                    Thêm Khoản Chi
                </button>
            </form>
        </section>
        
        <section class="p-4 mt-6 fade-in" style="animation-delay: 0.3s;">
            <h2 class="text-lg font-semibold text-gray-700 mb-3">Danh Sách Khoản Chi Chi Tiết</h2>
            <div id="expenseList" class="space-y-3"></div>
            <p id="emptyMessage" class="text-center text-gray-500 mt-8 py-4 bg-gray-100 rounded-xl hidden">
                Chưa có khoản chi nào. Hãy thêm một mục!
            </p>
        </section>

    </div>

    <script>
        // --- LOGIC QUẢN LÝ IFRAME ---
        const openBalanceBtn = document.getElementById('openBalanceBtn');
        const closeBalanceBtn = document.getElementById('closeBalanceBtn');
        const overlay = document.getElementById('balanceManagerOverlay');
        const iframe = document.getElementById('balanceIframe');

        openBalanceBtn.addEventListener('click', () => {
            iframe.src = 'sodu.html'; // Tải file sodu.html khi mở
            overlay.style.display = 'block';
            document.body.style.overflow = 'hidden'; // Chặn cuộn trang chính
        });

        closeBalanceBtn.addEventListener('click', () => {
            overlay.style.display = 'none';
            iframe.src = ''; // Giải phóng bộ nhớ iframe
            document.body.style.overflow = 'auto'; // Cho phép cuộn lại
        });


        // --- LOGIC ỨNG DỤNG GỐC ---
        let expenses = [];
        let expenseIdCounter = 1;
        const DAYS_PER_YEAR = 365.25;
        const DAYS_PER_MONTH = DAYS_PER_YEAR / 12;

        const form = document.getElementById('expenseForm');
        const listContainer = document.getElementById('expenseList');
        const dailyResultEl = document.getElementById('dailyResult');
        const monthlyResultEl = document.getElementById('monthlyResult');
        const xDaysInputContainer = document.getElementById('xDaysInputContainer');
        const frequencyUnitSelect = document.getElementById('frequencyUnit');
        const emptyMessage = document.getElementById('emptyMessage');
        const frequencyValueInput = document.getElementById('frequencyValue');
        const monthlyRevenueInput = document.getElementById('monthlyRevenue');
        const budgetBalanceEl = document.getElementById('budgetBalance');
        let totalMonthlyCost = 0;

        function formatVND(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function calculateDailyCost(expense) {
            const cost = parseFloat(expense.cost);
            const value = parseFloat(expense.frequencyValue || 1);
            if (isNaN(cost) || cost <= 0) return 0;
            switch (expense.frequencyUnit) {
                case 'yearly': return cost / DAYS_PER_YEAR;
                case 'monthly': return cost / DAYS_PER_MONTH;
                case 'weekly': return cost / 7;
                case 'daily': return cost;
                case 'x_days':
                    if (isNaN(value) || value <= 0) return 0;
                    return cost / value;
                default: return 0;
            }
        }

        function updateResults() {
            let totalDailyCost = 0;
            if (expenses.length > 0) {
                totalDailyCost = expenses.reduce((sum, expense) => sum + calculateDailyCost(expense), 0);
            }
            totalMonthlyCost = totalDailyCost * DAYS_PER_MONTH;
            dailyResultEl.textContent = formatVND(totalDailyCost);
            monthlyResultEl.textContent = formatVND(totalMonthlyCost);
            updateBudgetBalance();
            emptyMessage.classList.toggle('hidden', expenses.length > 0);
        }

        function updateBudgetBalance() {
            const monthlyRevenue = Math.max(0, parseFloat(monthlyRevenueInput.value) || 0); 
            const balance = monthlyRevenue - totalMonthlyCost;
            budgetBalanceEl.textContent = formatVND(balance);
            budgetBalanceEl.className = 'text-xl font-bold mt-1';
            if (balance > 0) {
                budgetBalanceEl.classList.add('text-profit');
            } else if (balance < 0) {
                budgetBalanceEl.classList.add('text-deficit');
            } else {
                budgetBalanceEl.classList.add('text-gray-800');
            }
        }

        monthlyRevenueInput.addEventListener('input', updateBudgetBalance);

        function renderExpenses() {
            listContainer.innerHTML = '';
            expenses.forEach(expense => {
                const dailyCost = calculateDailyCost(expense);
                let frequencyText = '';
                switch(expense.frequencyUnit) {
                    case 'yearly': frequencyText = `(${formatVND(expense.cost)} / năm)`; break;
                    case 'monthly': frequencyText = `(${formatVND(expense.cost)} / tháng)`; break;
                    case 'weekly': frequencyText = `(${formatVND(expense.cost)} / tuần)`; break;
                    case 'daily': frequencyText = `(${formatVND(expense.cost)} / ngày)`; break;
                    case 'x_days': frequencyText = `(${formatVND(expense.cost)} / ${expense.frequencyValue} ngày)`; break;
                }
                const itemHtml = `
                    <div class="expense-item flex justify-between items-center p-4 bg-white rounded-xl shadow-sm border border-gray-100 hover:shadow-md">
                        <div class="flex-1 min-w-0">
                            <p class="text-base font-semibold text-gray-800 truncate">${expense.name}</p>
                            <p class="text-xs text-gray-500 mt-0.5">${frequencyText}</p>
                            <p class="text-sm font-bold text-primary-teal mt-1">${formatVND(dailyCost)} / ngày</p>
                        </div>
                        <button data-id="${expense.id}" class="delete-btn flex-shrink-0 ml-4 p-2 bg-red-100 text-red-500 rounded-full hover:bg-red-200 transition duration-150 transform active:scale-90">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', itemHtml);
            });
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', handleDeleteExpense);
            });
            updateResults();
        }
        
        frequencyUnitSelect.addEventListener('change', (e) => {
            if (e.target.value === 'x_days') {
                xDaysInputContainer.classList.remove('hidden');
                frequencyValueInput.setAttribute('required', 'required');
            } else {
                xDaysInputContainer.classList.add('hidden');
                frequencyValueInput.removeAttribute('required');
                frequencyValueInput.value = 1;
            }
        });

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value.trim();
            const cost = parseFloat(document.getElementById('cost').value);
            const frequencyUnit = document.getElementById('frequencyUnit').value;
            const frequencyValue = document.getElementById('frequencyValue').value;

            if (!name || isNaN(cost) || cost <= 0) return;

            const newExpense = {
                id: expenseIdCounter++,
                name: name,
                cost: cost,
                frequencyUnit: frequencyUnit,
                frequencyValue: frequencyUnit === 'x_days' ? parseInt(frequencyValue) : 1, 
            };
            expenses.push(newExpense);
            renderExpenses();
            form.reset();
            frequencyUnitSelect.value = 'monthly';
            xDaysInputContainer.classList.add('hidden');
            frequencyValueInput.value = 1;
        });

        function handleDeleteExpense(e) {
            const button = e.target.closest('.delete-btn');
            const idToDelete = parseInt(button.dataset.id);
            const listItem = button.closest('.expense-item');
            listItem.style.opacity = '0';
            setTimeout(() => {
                expenses = expenses.filter(exp => exp.id !== idToDelete);
                renderExpenses();
            }, 300); 
        }

        window.onload = function() {
            expenses.push({ id: expenseIdCounter++, name: "Nghĩa vụ hàng năm", cost: 30000000, frequencyUnit: 'yearly', frequencyValue: 1 });
            expenses.push({ id: expenseIdCounter++, name: "Tiền giặt đồ", cost: 50000, frequencyUnit: 'x_days', frequencyValue: 7 });
            expenses.push({ id: expenseIdCounter++, name: "Tiền xăng", cost: 50000, frequencyUnit: 'x_days', frequencyValue: 3 });
            monthlyRevenueInput.value = 15000000;
            renderExpenses();
        }
    </script>
</body>
</html>
