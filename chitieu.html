<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>üí∞ Qu·∫£n L√Ω Chi Ti√™u N√¢ng C·∫•p iOS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ====================================
           I. BI·∫æN CSS V√Ä RESET CHU·∫®N IOS
           ==================================== */
        :root {
            /* 1. M√†u s·∫Øc theo chu·∫©n Apple */
            --ios-blue: #007AFF;
            --ios-blue-active: #005ac9;
            --ios-red: #FF3B30;
            --ios-green: #34C759;
            --ios-orange: #FF9500;
            --ios-background: #F5F5F7; /* N·ªÅn nh·∫°t, tinh t·∫ø */
            --ios-card-bg: rgba(255, 255, 255, 0.78); /* N·ªÅn m·ªù (Glassmorphism) */
            --ios-text-primary: #1C1C1E;
            --ios-text-secondary: #8E8E93;
            --ios-separator: rgba(60, 60, 67, 0.16); /* M√†u ph√¢n c√°ch nh·∫π */

            /* 2. B·ªë c·ª•c & Bo g√≥c */
            --breathing-space: 20px;
            --card-border-radius: 18px; /* G√≥c bo l·ªõn */
            --input-border-radius: 12px;
            --button-border-radius: 14px;
            --bottom-bar-height: 80px; /* Chi·ªÅu cao Tab Bar */

            /* 3. Hi·ªáu ·ª©ng & Animation */
            --ios-easing: cubic-bezier(0.25, 0.1, 0.25, 1);
            --ios-shadow-soft: 0 6px 20px rgba(0,0,0,0.08); /* B√≥ng m·ªÅm */
        }

        /* Reset v√† Font ch·ªØ Inter (thay cho SF Pro) */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            padding: 0;
            margin: 0;
            background: var(--ios-background);
            color: var(--ios-text-primary);
            /* ƒê·∫£m b·∫£o kho·∫£ng c√°ch an to√†n cho Bottom Tab Bar v√† Gesture Bar */
            padding-bottom: calc(var(--bottom-bar-height) + env(safe-area-inset-bottom, 20px));
            line-height: 1.4;
        }

        /* Thi·∫øt l·∫≠p responsive chu·∫©n iPhone */
        .container {
            padding: 0 var(--breathing-space);
            max-width: 430px; /* Max width c·ªßa iPhone Pro Max */
            margin: 0 auto;
        }

        /* ====================================
           II. HEADER (T∆∞∆°ng t·ª± Large Title iOS)
           ==================================== */
        .header {
            padding: 60px var(--breathing-space) 20px; /* Padding l·ªõn cho Large Title style */
            background: var(--ios-background);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: background-color 0.3s var(--ios-easing);
            /* B·ªè border-bottom ƒë·ªÉ t·∫°o c·∫£m gi√°c trong su·ªët khi kh√¥ng scroll */
        }

        h1 {
            font-size: 26px; /* Title: 20‚Äì28px, ƒë·∫≠m */
            font-weight: 700;
            margin: 0;
            color: var(--ios-text-primary);
            letter-spacing: -0.5px;
        }

        /* ====================================
           III. CARD (Glassmorphism/Card m·ªù ƒë·ª•c)
           ==================================== */
        .box {
            background: var(--ios-card-bg);
            /* Hi·ªáu ·ª©ng M·ªù (Glassmorphism) */
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: var(--breathing-space);
            border-radius: var(--card-border-radius);
            margin-top: var(--breathing-space);
            box-shadow: var(--ios-shadow-soft);
            transition: transform 0.3s var(--ios-easing), box-shadow 0.3s var(--ios-easing);
        }

        .box:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        h2 {
            font-size: 20px;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--ios-text-primary);
        }

        /* ====================================
           IV. INPUT/SELECT (Bo tr√≤n & Glow nh·∫π)
           ==================================== */
        input[type="text"], input[type="number"], input[type="date"], select {
            padding: 14px 15px;
            border-radius: var(--input-border-radius);
            border: 1px solid var(--ios-separator);
            margin-top: 10px;
            width: 100%;
            box-sizing: border-box;
            font-size: 16px;
            background: #FFFFFF; /* M√†u tr·∫Øng cho input */
            color: var(--ios-text-primary);
            transition: border-color 0.3s var(--ios-easing), box-shadow 0.3s var(--ios-easing), background 0.3s;
            -webkit-appearance: none; /* B·ªè style m·∫∑c ƒë·ªãnh c·ªßa tr√¨nh duy·ªát */
        }

        input:focus, select:focus {
            border-color: var(--ios-blue);
            outline: none;
            /* Animation focus glow nh·∫π */
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.2);
            background: #FFFFFF;
        }
        
        select {
            /* T√πy ch·ªânh m≈©i t√™n th·∫£ xu·ªëng cho ƒë·∫πp h∆°n */
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20'%3e%3cpath fill='%238E8E93' d='M5 8l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            padding-right: 35px;
        }

        /* Group input v√† button */
        .input-group {
            display: flex;
            gap: 10px;
        }
        .input-group input[type="date"] {
            flex-grow: 1;
            margin-top: 0;
        }
        .input-group button {
            width: auto;
            min-width: 80px;
            margin-top: 0;
            font-size: 15px;
            padding: 10px 15px;
        }
        /* Fix input date padding khi n·∫±m trong group */
        .box .input-group > input[type="date"] {
            padding: 14px 15px;
            margin-top: 10px;
        }


        /* ====================================
           V. BUTTONS (Spring Scale Effect)
           ==================================== */
        button {
            padding: 15px;
            border-radius: var(--button-border-radius);
            border: none;
            margin-top: 20px;
            width: 100%;
            font-size: 17px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            background: var(--ios-blue);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
            transition: background 0.2s var(--ios-easing), transform 0.2s var(--ios-easing), box-shadow 0.2s var(--ios-easing);
            -webkit-tap-highlight-color: transparent; /* B·ªè highlight khi ch·∫°m tr√™n iOS */
        }

        /* Button khi nh·∫•n (Spring Scale 0.97) */
        button:active {
            background: var(--ios-blue-active);
            transform: scale(0.97); 
            box-shadow: 0 2px 4px rgba(0, 122, 255, 0.4);
            transition: transform 0.1s cubic-bezier(0.4, 0.0, 0.2, 1.4); /* Hi·ªáu ·ª©ng spring-like */
        }
        
        /* N√∫t X√≥a (Delete Button) */
        .delete-btn {
            padding: 8px 12px;
            margin-top: 0;
            width: auto;
            background: var(--ios-red);
            font-size: 13px;
            font-weight: 500;
            border-radius: 8px;
            box-shadow: none;
        }
        .delete-btn:active {
            background: #c90a00;
            transform: scale(0.97);
        }
        /* N√∫t l·ªçc */
        #filterExpenseBtn {
            background: var(--ios-orange);
            box-shadow: 0 4px 12px rgba(255, 149, 0, 0.3);
        }
        #filterExpenseBtn:active {
            background: #cc7400;
        }

        /* ====================================
           VI. LISTS & SUMMARY (Ki·ªÉu Cell iOS)
           ==================================== */
        #categoryList {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        #categoryList span {
            display: inline-block;
            background: rgba(0, 122, 255, 0.1);
            color: var(--ios-blue);
            padding: 6px 12px;
            border-radius: 10px;
            font-weight: 500;
            font-size: 15px;
        }
        
        /* Summary Item & Expense Item */
        .summary-item, .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 0.5px solid var(--ios-separator);
            font-size: 16px;
            line-height: 1.4;
        }
        .summary-item:last-child, .expense-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        .summary-item:first-child, .expense-item:first-child {
            padding-top: 0;
        }
        
        /* M√†u gi√° tr·ªã */
        .income-value { color: var(--ios-green); font-weight: 600; }
        .expense-value { color: var(--ios-red); font-weight: 600; }
        .remain-value { font-size: 18px; font-weight: 700; color: var(--ios-blue); }
        .today-spent-value { color: var(--ios-orange); font-weight: 600; }
        .category-summary-amount { font-weight: 600; color: var(--ios-red); }

        .expense-item .label {
            flex-grow: 1;
            font-size: 15px;
        }
        .expense-item .date {
            font-size: 12px;
            color: var(--ios-text-secondary);
            margin-right: 15px;
            white-space: nowrap;
        }
        .expense-item .amount {
            font-weight: 600;
            color: var(--ios-red);
            margin-right: 15px;
            white-space: nowrap;
        }

        /* ====================================
           VII. BOTTOM TAB BAR (Thanh ƒêi·ªÅu H∆∞·ªõng D∆∞·ªõi)
           ==================================== */
        .bottom-tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--bottom-bar-height);
            background: var(--ios-card-bg);
            /* Glassmorphism */
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-top: 0.5px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 -4px 16px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            padding: 10px 0;
            /* Kho·∫£ng c√°ch an to√†n d∆∞·ªõi c√πng */
            padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
            z-index: 200;
        }
        
        .tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: var(--ios-text-secondary);
            font-size: 10px;
            font-weight: 500;
            transition: color 0.2s var(--ios-easing);
            -webkit-tap-highlight-color: transparent;
        }

        .tab-item.active {
            color: var(--ios-blue);
        }

        .tab-icon {
            font-size: 24px;
            margin-bottom: 3px;
            line-height: 1;
        }

        /* ====================================
           VIII. C√ÅC HI·ªÜU ·ª®NG KH√ÅC (JavaScript/Scroll)
           ==================================== */
        /* Hi·ªáu ·ª©ng Header trong su·ªët khi scroll */
        .header.scrolled {
            background-color: var(--ios-card-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 0.5px solid var(--ios-separator);
            padding: 15px var(--breathing-space); /* Gi·∫£m padding khi scroll */
        }
        .header.scrolled h1 {
            font-size: 20px; /* Gi·∫£m c·ª° ch·ªØ */
        }

        /* Toast Notification (Demo) */
        .ios-toast {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translate(-50%, -150%); /* ·∫®n ƒëi */
            background: rgba(45, 45, 45, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 15px;
            z-index: 300;
            transition: transform 0.5s var(--ios-easing), opacity 0.5s var(--ios-easing);
            opacity: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .ios-toast.show {
            transform: translate(-50%, 0);
            opacity: 1;
        }

    </style>
</head>
<body>

<div class="header" id="mainHeader">
    <h1>üí∞ Qu·∫£n L√Ω Chi Ti√™u</h1>
</div>

<div class="container">
    <div class="box">
        <h2>üíµ Doanh thu th√°ng</h2>
        <input type="text" id="monthlyIncome" placeholder="Nh·∫≠p s·ªë ti·ªÅn doanh thu th√°ng...">
        <input type="date" id="incomeDateInput" value="<?php echo date('Y-m-d'); ?>">
        <button id="saveIncome">L∆∞u Doanh Thu</button>
    </div>

    <div class="box">
        <h2>‚ûï Th√™m kho·∫£n chi</h2>
        <input type="text" id="categoryInput" placeholder="V√≠ d·ª•: ƒÇn u·ªëng, XƒÉng, Cafe, Ti·∫øt ki·ªám...">
        <button id="addCategory">Th√™m H·∫°ng M·ª•c</button>
        <div id="categoryList"></div>
    </div>

    <div class="box">
        <h2>üìù Ghi chi ti√™u</h2>
        <select id="selectCategory">
            </select>
        <input type="text" id="expenseAmount" placeholder="Nh·∫≠p s·ªë ti·ªÅn ƒë√£ chi...">
        <button id="addExpense">Ghi Chi Ti√™u</button>
    </div>

    <div class="box summary">
        <h2>üìà T·ªïng quan</h2>
        <div class="summary-item" id="showIncome">Doanh thu th√°ng: <strong class="income-value">0 ƒë</strong></div>
        <div class="summary-item" id="showIncomeDate">Ng√†y ghi nh·∫≠n: <strong style="color:var(--ios-text-secondary);">N/A</strong></div>
        <div class="summary-item" id="showTotalSpent">T·ªïng chi: <strong class="expense-value">0 ƒë</strong></div>
        <div class="summary-item" id="showRemain">C√≤n l·∫°i: <strong class="remain-value">0 ƒë</strong></div>
        <div class="summary-item" id="showTodaySpent">Chi h√¥m nay: <strong class="today-spent-value">0 ƒë</strong></div>
    </div>
    
    <div class="box">
        <h2>üè∑Ô∏è T·ªïng chi theo kho·∫£n</h2>
        <div id="categorySummary">
            </div>
    </div>
    
    <div class="box">
        <h2>üîé L·ªçc Chi ti√™u theo ng√†y</h2>
        <div class="input-group">
             <input type="date" id="filterDateInput" value="<?php echo date('Y-m-d'); ?>">
             <button id="filterExpenseBtn">L·ªçc</button>
        </div>
        
        <div id="filteredExpenseSummary" class="summary-item" style="margin-top: 20px; font-weight: 500; padding: 0;">
             T·ªïng chi ng√†y <span id="filteredDateValue">H√¥m nay</span>: <strong class="expense-value" id="filteredTotalAmount">0 ƒë</strong>
        </div>
        
    </div>

    <div class="box" id="expenseHistoryBox">
        <h2>‚è≥ L·ªãch s·ª≠ Chi ti√™u (<span id="historyTitle">To√†n b·ªô</span>)</h2>
        <div id="expenseHistory">
            </div>
    </div>
</div>

<div class="bottom-tab-bar">
    <a href="#" class="tab-item active">
        <span class="tab-icon">üìä</span>
        <span>T·ªïng quan</span>
    </a>
    <a href="#" class="tab-item">
        <span class="tab-icon">‚ûï</span>
        <span>Ghi chi</span>
    </a>
    <a href="#" class="tab-item">
        <span class="tab-icon">‚öôÔ∏è</span>
        <span>C√†i ƒë·∫∑t</span>
    </a>
</div>

<div class="ios-toast" id="iosToast">Th√†nh c√¥ng!</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

// V·∫´n gi·ªØ nguy√™n c·∫•u h√¨nh v√† logic Firebase
const firebaseConfig = {
  apiKey: "AIzaSyC4k2DyiEVKXcMpc_j9XwqZG1OHHBNegDk",
  authDomain: "lichnghi-4c665.firebaseapp.com",
  databaseURL: "https://lichnghi-4c665-default-rtdb.firebaseio.com",
  projectId: "lichnghi-4c665",
  storageBucket: "lichnghi-4c665.firebasestorage.app",
  messagingSenderId: "86673813509",
  appId: "1:86673813509:web:168376408dfcbf14e16c6c",
  measurementId: "G-2G08MRQY1V"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth();
signInAnonymously(auth);

// Elements
const monthlyIncomeInput = document.getElementById("monthlyIncome");
const incomeDateInput = document.getElementById("incomeDateInput");
const saveIncomeBtn = document.getElementById("saveIncome");
const categoryInput = document.getElementById("categoryInput");
const addCategoryBtn = document.getElementById("addCategory");
const categoryList = document.getElementById("categoryList");
const categorySelect = document.getElementById("selectCategory");
const expenseAmountInput = document.getElementById("expenseAmount");
const addExpenseBtn = document.getElementById("addExpense");

const showIncome = document.getElementById("showIncome");
const showIncomeDate = document.getElementById("showIncomeDate");
const showTotalSpent = document.getElementById("showTotalSpent");
const showRemain = document.getElementById("showRemain");
const showTodaySpent = document.getElementById("showTodaySpent");
const categorySummaryDiv = document.getElementById("categorySummary");
const expenseHistoryDiv = document.getElementById("expenseHistory");

const mainHeader = document.getElementById("mainHeader");
const iosToast = document.getElementById("iosToast");

// Elements m·ªõi cho l·ªçc theo ng√†y
const filterDateInput = document.getElementById("filterDateInput");
const filterExpenseBtn = document.getElementById("filterExpenseBtn");
const historyTitle = document.getElementById("historyTitle");
const filteredDateValue = document.getElementById("filteredDateValue");
const filteredTotalAmount = document.getElementById("filteredTotalAmount");

// Bi·∫øn l∆∞u tr·ªØ l·ªãch s·ª≠ chi ti√™u g·ªëc (d√πng cho vi·ªác l·ªçc)
let allExpenses = {};
let currentFilterDate = null; // Bi·∫øn l∆∞u tr·ªØ ng√†y ƒëang l·ªçc

// --- H√ÄM H·ªñ TR·ª¢ ---

// Format ti·ªÅn t·ªá
const formatCurrency = (amount) => {
    return amount.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }).replace('‚Ç´', ' ƒë');
};

// H√†m ƒë·ªãnh d·∫°ng ng√†y
const formatDate = (dateString) => {
    if (!dateString) return 'N/A';
    const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
    return new Date(dateString).toLocaleDateString('vi-VN', options);
};

// H√†m x·ª≠ l√Ω ƒë·ªãnh d·∫°ng s·ªë ti·ªÅn khi nh·∫≠p (th√™m d·∫•u ch·∫•m)
const formatInput = (inputElement) => {
    let value = inputElement.value.replace(/[^0-9]/g, ''); // Ch·ªâ gi·ªØ l·∫°i s·ªë
    if (value) {
        // ƒê·ªãnh d·∫°ng s·ªë (th√™m d·∫•u .)
        inputElement.value = new Intl.NumberFormat('vi-VN').format(Number(value));
    }
};

// H√†m l·∫•y gi√° tr·ªã s·ªë nguy√™n t·ª´ input
const getNumericValue = (inputElement) => {
    const value = inputElement.value.replace(/[^0-9]/g, '');
    return Number(value);
};


// --- ANIMATION V√Ä UX TH√äM ---

// 1. Header trong su·ªët khi scroll
window.addEventListener('scroll', () => {
    if (window.scrollY > 10) { // Kho·∫£ng c√°ch scroll ƒë·ªÉ k√≠ch ho·∫°t
        mainHeader.classList.add('scrolled');
    } else {
        mainHeader.classList.remove('scrolled');
    }
});

// 2. Toast Notification
const showToast = (message) => {
    iosToast.textContent = message;
    iosToast.classList.add('show');
    
    // T·ª± ƒë·ªông ·∫©n sau 3 gi√¢y
    setTimeout(() => {
        iosToast.classList.remove('show');
    }, 3000);
};

// 3. Hi·ªáu ·ª©ng Spring Scale cho buttons (ƒë√£ c√≥ trong CSS :active)
document.querySelectorAll('button').forEach(button => {
    button.addEventListener('mousedown', () => {
        button.style.transform = 'scale(0.97)';
        button.style.transition = 'transform 0.1s cubic-bezier(0.4, 0.0, 0.2, 1.4)';
    });
    button.addEventListener('mouseup', () => {
        button.style.transform = 'scale(1.0)';
        button.style.transition = 'transform 0.2s cubic-bezier(0.25, 0.1, 0.25, 1)';
    });
    button.addEventListener('touchstart', () => {
        button.style.transform = 'scale(0.97)';
        button.style.transition = 'transform 0.1s cubic-bezier(0.4, 0.0, 0.2, 1.4)';
    });
    button.addEventListener('touchend', () => {
        button.style.transform = 'scale(1.0)';
        button.style.transition = 'transform 0.2s cubic-bezier(0.25, 0.1, 0.25, 1)';
    });
});

// 4. T·ª± ƒë·ªông ƒë·ªãnh d·∫°ng s·ªë ti·ªÅn khi nh·∫≠p
monthlyIncomeInput.addEventListener('input', () => formatInput(monthlyIncomeInput));
expenseAmountInput.addEventListener('input', () => formatInput(expenseAmountInput));


// --- CH·ª®C NƒÇNG X√ìA (DELETE) ---
window.deleteExpense = (key) => {
    if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kho·∫£n chi n√†y?")) {
        remove(ref(db, "expenses/" + key))
            .then(() => showToast("X√≥a chi ti√™u th√†nh c√¥ng!"))
            .catch(() => showToast("L·ªói khi x√≥a!"));
    }
};

// Save income
saveIncomeBtn.onclick = () => {
    const incomeValue = getNumericValue(monthlyIncomeInput);
    const incomeDate = incomeDateInput.value;
    if (!isNaN(incomeValue) && incomeDate) {
        set(ref(db, "budget/monthlyIncome"), {
            amount: incomeValue,
            date: incomeDate
        })
        .then(() => showToast("L∆∞u Doanh Thu th√†nh c√¥ng!"))
        .catch(() => showToast("L·ªói khi l∆∞u Doanh Thu!"));
    } else {
        showToast("Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá v√† ng√†y!");
    }
};

// Add category
addCategoryBtn.onclick = () => {
  const category = categoryInput.value.trim();
  if (category) {
    set(ref(db, "budget/categories/" + category), true)
        .then(() => {
            categoryInput.value = "";
            showToast("Th√™m H·∫°ng M·ª•c th√†nh c√¥ng!");
        })
        .catch(() => showToast("L·ªói khi th√™m H·∫°ng M·ª•c!"));
  } else {
      showToast("Vui l√≤ng nh·∫≠p t√™n h·∫°ng m·ª•c!");
  }
};

// Listen categories
onValue(ref(db, "budget/categories"), snap => {
  categorySelect.innerHTML = "";
  categoryList.innerHTML = "";
  if (snap.exists()) {
    Object.keys(snap.val()).forEach(c => {
      categorySelect.innerHTML += `<option value="${c}">${c}</option>`;
      categoryList.innerHTML += `<span>${c}</span>`;
    });
  } else {
      categorySelect.innerHTML = `<option value="">Ch∆∞a c√≥ h·∫°ng m·ª•c</option>`;
  }
});

// Add expense
addExpenseBtn.onclick = () => {
  const amountValue = getNumericValue(expenseAmountInput);
  if (categorySelect.value && !isNaN(amountValue) && amountValue > 0) {
    push(ref(db, "expenses"), {
      category: categorySelect.value,
      amount: amountValue,
      date: new Date().toISOString().split("T")[0] // Ghi ng√†y chi ti√™u
    })
    .then(() => {
        expenseAmountInput.value = "";
        showToast("Ghi Chi Ti√™u th√†nh c√¥ng!");
    })
    .catch(() => showToast("L·ªói khi ghi Chi Ti√™u!"));
  } else {
      showToast("Vui l√≤ng ch·ªçn h·∫°ng m·ª•c v√† nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá!");
  }
};


// --- CH·ª®C NƒÇNG L·ªåC V√Ä HI·ªÇN TH·ªä L·ªäCH S·ª¨ ---

// H√†m chung ƒë·ªÉ hi·ªÉn th·ªã l·ªãch s·ª≠ chi ti√™u
const renderExpenseHistory = (expensesToRender, filterDate = null) => {
    expenseHistoryDiv.innerHTML = "";
    
    // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ
    if (filterDate) {
        const displayDate = filterDate === new Date().toISOString().split("T")[0] ? "H√¥m nay" : formatDate(filterDate);
        historyTitle.textContent = `Ng√†y ${displayDate}`;
    } else {
        historyTitle.textContent = "To√†n b·ªô";
    }

    if (Object.keys(expensesToRender).length > 0) {
        let items = Object.keys(expensesToRender).map(key => ({ key: key, ...expensesToRender[key] }));
        
        // S·∫Øp x·∫øp theo ng√†y m·ªõi nh·∫•t l√™n tr∆∞·ªõc
        items.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        items.forEach(item => {
            expenseHistoryDiv.innerHTML += `
                <div class="expense-item">
                    <span class="label">${item.category}</span>
                    <span class="date">${formatDate(item.date)}</span>
                    <span class="amount">${formatCurrency(item.amount)}</span>
                    <button class="delete-btn" onclick="deleteExpense('${item.key}')">X√≥a</button>
                </div>
            `;
        });
    } else {
        expenseHistoryDiv.innerHTML = "<p style='text-align:center; color:var(--ios-text-secondary);'>Kh√¥ng c√≥ l·ªãch s·ª≠ chi ti√™u n√†o cho ng√†y n√†y.</p>";
    }
};

// H√†m x·ª≠ l√Ω vi·ªác l·ªçc (ch·ªâ filter expenseHistory)
const filterExpenses = (date) => {
    currentFilterDate = date;
    let filteredExpenses = {};
    let totalFilteredAmount = 0;
    const today = new Date().toISOString().split("T")[0];
    const displayDate = date === today ? "H√¥m nay" : formatDate(date);

    Object.keys(allExpenses).forEach(key => {
        const e = allExpenses[key];
        if (e.date === date) {
            filteredExpenses[key] = e;
            totalFilteredAmount += e.amount;
        }
    });

    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã t·ªïng chi ng√†y l·ªçc
    filteredDateValue.textContent = displayDate;
    filteredTotalAmount.textContent = formatCurrency(totalFilteredAmount);

    renderExpenseHistory(filteredExpenses, date);
};

// Event click n√∫t L·ªçc
filterExpenseBtn.onclick = () => {
    const selectedDate = filterDateInput.value;
    if (selectedDate) {
        filterExpenses(selectedDate);
    } else {
        showToast("Vui l√≤ng ch·ªçn m·ªôt ng√†y ƒë·ªÉ l·ªçc!");
    }
};

// M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã chi h√¥m nay ngay khi load
window.onload = () => {
    filterExpenses(new Date().toISOString().split("T")[0]);
};


// Stats Listener (C·∫≠p nh·∫≠t T·ªïng quan v√† T·ªïng chi theo kho·∫£n)
onValue(ref(db, "/"), snap => {
  if (!snap.exists()) {
      allExpenses = {}; // Reset l·ªãch s·ª≠
      // Set default values if data doesn't exist
      showIncome.innerHTML = `Doanh thu th√°ng: <strong class="income-value">${formatCurrency(0)}</strong>`;
      showIncomeDate.innerHTML = `Ng√†y ghi nh·∫≠n: <strong style="color:var(--ios-text-secondary);">Ch∆∞a c√≥</strong>`;
      showTotalSpent.innerHTML = `T·ªïng chi: <strong class="expense-value">${formatCurrency(0)}</strong>`;
      showRemain.innerHTML = `C√≤n l·∫°i: <strong class="remain-value">${formatCurrency(0)}</strong>`;
      showTodaySpent.innerHTML = `Chi h√¥m nay: <strong class="today-spent-value">${formatCurrency(0)}</strong>`;
      categorySummaryDiv.innerHTML = "<p style='text-align:center; color:var(--ios-text-secondary);'>Ch∆∞a c√≥ kho·∫£n chi n√†o.</p>";
      renderExpenseHistory({}); // Hi·ªÉn th·ªã l·ªãch s·ª≠ tr·ªëng
      return;
  }
  
  const data = snap.val();
  
  // L·∫•y th√¥ng tin thu nh·∫≠p
  const incomeData = data.budget?.monthlyIncome || { amount: 0, date: null };
  const income = incomeData.amount || 0;
  const incomeDate = incomeData.date;
  
  allExpenses = data.expenses || {}; // L∆ØU TO√ÄN B·ªò EXPENSES

  let totalSpent = 0;
  let todaySpent = 0;
  const today = new Date().toISOString().split("T")[0];
  const categorySummaries = {}; // Th·ªëng k√™ theo kho·∫£n

  Object.keys(allExpenses).forEach(key => {
    const e = allExpenses[key];
    totalSpent += e.amount;
    
    // Th·ªëng k√™ chi h√¥m nay
    if (e.date === today) todaySpent += e.amount;
    
    // Th·ªëng k√™ theo kho·∫£n
    categorySummaries[e.category] = (categorySummaries[e.category] || 0) + e.amount;
  });

  const remaining = income - totalSpent;

  // --- HI·ªÇN TH·ªä TH·ªêNG K√ä CHUNG ---
  showIncome.innerHTML = `Doanh thu th√°ng: <strong class="income-value">${formatCurrency(income)}</strong>`;
  showIncomeDate.innerHTML = `Ng√†y ghi nh·∫≠n: <strong style="color:var(--ios-text-secondary);">${incomeDate ? formatDate(incomeDate) : 'Ch∆∞a c√≥'}</strong>`;
  showTotalSpent.innerHTML = `T·ªïng chi: <strong class="expense-value">${formatCurrency(totalSpent)}</strong>`;
  showRemain.innerHTML = `C√≤n l·∫°i: <strong class="remain-value">${formatCurrency(remaining)}</strong>`;
  showTodaySpent.innerHTML = `Chi h√¥m nay: <strong class="today-spent-value">${formatCurrency(todaySpent)}</strong>`;

  // C·∫≠p nh·∫≠t l·∫°i gi√° tr·ªã input doanh thu n·∫øu ƒë√£ c√≥
  if(income > 0) {
      monthlyIncomeInput.value = new Intl.NumberFormat('vi-VN').format(income); // ƒê·ªãnh d·∫°ng s·ªë ti·ªÅn
  }
  if(incomeDate) {
      incomeDateInput.value = incomeDate;
  }
  
  // --- HI·ªÇN TH·ªä T·ªîNG CHI THEO KHO·∫¢N ---
  categorySummaryDiv.innerHTML = "";
  if (Object.keys(categorySummaries).length > 0) {
      Object.keys(categorySummaries).sort().forEach(category => {
          categorySummaryDiv.innerHTML += `
              <div class="summary-item">
                  <span class="label">${category}:</span>
                  <span class="category-summary-amount">${formatCurrency(categorySummaries[category])}</span>
              </div>
          `;
      });
  } else {
      categorySummaryDiv.innerHTML = "<p style='text-align:center; color:var(--ios-text-secondary);'>Ch∆∞a c√≥ kho·∫£n chi n√†o.</p>";
  }

  // --- √ÅP D·ª§NG B·ªò L·ªåC ƒê√É CH·ªåN (ho·∫∑c l·ªçc ng√†y h√¥m nay) ---
  const dateToFilter = currentFilterDate || today;
  filterExpenses(dateToFilter);
});
</script>

</body>
</html>
