<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <title>Qu·∫£n l√Ω nh√¢n vi√™n ‚Äî iOS Style</title>
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    /* * 1. iOS DESIGN SYSTEM 
     * Variables & Reset
     */
    :root {
      --ios-font: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --ios-bg: #F2F2F7;
      --ios-card: #FFFFFF;
      --ios-blue: #007AFF;
      --ios-blue-gradient: linear-gradient(135deg, #007AFF, #0055B3);
      --ios-red: #FF3B30;
      --ios-text-primary: #000000;
      --ios-text-secondary: #8E8E93;
      --ios-separator: #C6C6C8;
      --ios-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --ios-radius: 14px;
      --ios-easing: cubic-bezier(0.32, 1, 0.23, 1); /* iOS Spring feel */
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      padding: 0;
      font-family: var(--ios-font);
      background-color: var(--ios-bg);
      color: var(--ios-text-primary);
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
      min-height: 100vh;
      padding-bottom: 100px; /* Space for FAB */
    }

    h1, h2, h3, p { margin: 0; }

    /* * 2. BRANCH SELECTION POPUP (Startup)
     */
    #branch-popup {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(242, 242, 247, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      z-index: 2000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      transition: opacity 0.5s ease, visibility 0.5s;
    }

    #branch-popup.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .branch-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 32px;
      text-align: center;
    }

    .branch-card {
      width: 100%;
      max-width: 340px;
      background: var(--ios-card);
      padding: 24px;
      margin-bottom: 16px;
      border-radius: 20px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      text-align: center;
      cursor: pointer;
      transition: transform 0.2s var(--ios-easing);
      
      display: flex;
      flex-direction: column;
      align-items: center; 
    }

    .branch-card:active { transform: scale(0.96); }
    
    .branch-icon {
      width: 80px;  
      height: 80px;
      object-fit: contain;
      margin-bottom: 16px;
      border-radius: 16px;
    }

    .branch-name { font-size: 18px; font-weight: 600; color: var(--ios-blue); }

    /* * 3. MAIN HEADER & SEARCH
     */
    header {
      padding: 20px 16px 10px;
      background: var(--ios-bg);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    /* ADDED: Container cho n√∫t Quay v·ªÅ */
    .nav-bar-top {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        padding-bottom: 5px;
    }
    
    .btn-back {
        display: flex;
        align-items: center;
        font-size: 17px;
        font-weight: 400; /* iOS back button is light */
        color: var(--ios-blue);
        padding: 0;
        margin-left: -5px; /* K√©o n√∫t v·ªÅ s√°t m√©p */
    }
    
    .back-icon {
        width: 10px;
        height: 18px;
        margin-right: 4px;
        fill: none;
        stroke: var(--ios-blue);
        /* K√≠ch th∆∞·ªõc v√† v·ªã tr√≠ m≈©i t√™n iOS */
        transform: translateY(1px); 
    }

    .app-title {
      font-size: 34px;
      font-weight: 800;
      margin-bottom: 12px;
      letter-spacing: -0.5px;
    }

    .search-container {
      position: relative;
    }

    .search-bar {
      width: 100%;
      background: #E3E3E8;
      border: none;
      border-radius: 10px;
      padding: 10px 12px 10px 36px;
      font-size: 17px;
      color: var(--ios-text-primary);
      outline: none;
    }

    .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--ios-text-secondary);
      width: 18px;
      height: 18px;
    }

    /* * 4. EMPLOYEE LIST (Cards)
     */
    #employee-list {
      list-style: none;
      padding: 10px 16px;
      margin: 0;
    }

    .emp-card {
      background: var(--ios-card);
      border-radius: var(--ios-radius);
      padding: 14px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      box-shadow: var(--ios-shadow);
      position: relative;
      cursor: pointer; 
      transition: transform 0.2s var(--ios-easing), background-color 0.2s;
      
      opacity: 0;
      transform: translateY(20px);
      animation: iosSlideUp 0.5s var(--ios-easing) forwards;
    }

    .emp-card:active {
      transform: scale(0.98);
      background-color: #F2F2F2;
    }

    @keyframes iosSlideUp {
      to { opacity: 1; transform: translateY(0); }
    }

    .avatar {
      width: 50px;
      height: 50px;
      border-radius: 14px;
      background-color: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 20px;
      color: #fff;
      margin-right: 14px;
      flex-shrink: 0;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .info { flex: 1; min-width: 0; }
    
    .info h3 {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .info p { font-size: 14px; color: var(--ios-text-secondary); margin-bottom: 2px; }
    
    .badge {
      font-size: 11px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 20px;
      background: #F2F2F7;
      color: var(--ios-text-secondary);
      margin-left: 8px;
      white-space: nowrap;
    }

    /* * 5. FLOATING ACTION BUTTON (FAB)
     */
    #fab {
      position: fixed;
      bottom: 30px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 28px;
      background: var(--ios-blue-gradient);
      color: white;
      border: none;
      box-shadow: 0 6px 16px rgba(0, 122, 255, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 500;
      transition: transform 0.3s;
      animation: float 3s ease-in-out infinite;
    }

    #fab svg { width: 28px; height: 28px; fill: white; }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }

    #fab:active { transform: scale(0.9); animation: none; }

    /* * 6. SLIDE-IN FORM (Modal Sheet)
     */
    #form-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.3);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s;
    }

    #slide-form {
      position: fixed;
      top: 10%; 
      left: 0;
      width: 100%;
      height: 90%;
      background: #F2F2F7;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      transform: translateY(100%);
      transition: transform 0.4s var(--ios-easing);
      z-index: 1001;
      display: flex;
      flex-direction: column;
    }

    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: #F2F2F7;
      border-bottom: 0.5px solid rgba(0,0,0,0.1);
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
    }

    .btn-text {
      background: none; border: none; font-size: 17px; cursor: pointer; padding: 5px;
    }
    .btn-cancel { color: var(--ios-blue); }
    .btn-save { color: var(--ios-blue); font-weight: 600; }
    .form-title { font-weight: 600; font-size: 17px; }

    .form-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    /* Form Fields iOS Style */
    .form-group {
      background: white;
      border-radius: 12px;
      padding: 0 16px;
      margin-bottom: 24px;
      overflow: hidden;
    }

    .field-row {
      display: flex;
      flex-direction: column;
      padding: 12px 0;
      border-bottom: 0.5px solid #E5E5EA;
    }

    .field-row:last-child { border-bottom: none; }

    .field-row label {
      font-size: 13px;
      color: var(--ios-text-secondary);
      margin-bottom: 4px;
    }

    .field-row input, .field-row select, .field-row textarea {
      width: 100%;
      border: none;
      font-size: 17px;
      font-family: var(--ios-font);
      outline: none;
      background: transparent;
      padding: 4px 0;
    }
    
    /* Center Modal Sheet for Editing/Viewing */
    #edit-modal {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.4);
        z-index: 1500;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }
    
    #edit-form-card {
        width: 100%;
        max-width: 500px;
        background: #F2F2F7;
        border-radius: 16px;
        box-shadow: var(--ios-shadow);
        overflow: hidden;
        transform: scale(0.8);
        opacity: 0;
        transition: transform 0.4s var(--ios-easing), opacity 0.4s var(--ios-easing);
    }

    #edit-modal.active {
        opacity: 1;
        visibility: visible;
    }
    
    #edit-modal.active #edit-form-card {
        transform: scale(1);
        opacity: 1;
    }

    .edit-header {
        background: white; 
        border-bottom: 0.5px solid #E5E5EA;
        padding: 14px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .edit-header .form-title { font-weight: 700; font-size: 19px; }

    .edit-form-content { padding: 16px; background: #F2F2F7; max-height: 80vh; overflow-y: auto;}

    .delete-button-container {
        padding: 0 16px;
    }
    
    .btn-full-red {
        width: 100%;
        background-color: white;
        color: var(--ios-red);
        border: 1px solid var(--ios-red);
        border-radius: 12px;
        padding: 12px;
        font-size: 17px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .btn-full-red:active { background-color: #ffebeb; }


    .form-active #form-overlay { opacity: 1; visibility: visible; }
    .form-active #slide-form { transform: translateY(0); }

    /* Messages */
    .toast {
      position: fixed;
      top: 50px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      padding: 10px 20px;
      border-radius: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 3000;
      font-weight: 500;
      display: none;
      animation: fadeToast 3s forwards;
    }
    @keyframes fadeToast {
      0% { opacity: 0; top: 40px; }
      10% { opacity: 1; top: 50px; }
      80% { opacity: 1; }
      100% { opacity: 0; visibility: hidden; }
    }
    .toast.success { color: #34C759; }
    .toast.error { color: #FF3B30; }

  </style>
</head>
<body>

  <div id="branch-popup">
    <div class="branch-title">Ch·ªçn chi nh√°nh</div>
    
    <div class="branch-card" onclick="selectBranch('cherrypet')">
      <img src="logocherry.png" alt="Logo CherryPet" class="branch-icon">
      <span class="branch-name">CherryPet</span>
    </div>

    <div class="branch-card" onclick="selectBranch('amthucbuonme')">
      <img src="logobanme.png" alt="Logo BanMe" class="branch-icon">
      <span class="branch-name">·∫®m th·ª±c Bu√¥n M√™</span>
    </div>
  </div>

  <header>
    <div class="nav-bar-top">
        <button class="btn-text btn-back" type="button" onclick="showBranchSelection()">
            <svg class="back-icon" viewBox="0 0 13 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10.7495 18.0673L2.68452 9.99986L10.7495 1.93241" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span style="margin-left: -5px;">Quay v·ªÅ</span>
        </button>
    </div>
    
    <div class="app-title">Nh√¢n vi√™n</div>
    <div class="search-container">
      <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M21.71 20.29l-5.01-5.01C17.54 13.68 18 11.91 18 10c0-4.41-3.59-8-8-8S2 5.59 2 10s3.59 8 8 8c1.91 0 3.68-.46 5.28-1.3l5.01 5.01c.39.39 1.02.39 1.41 0 .39-.38.39-1.01.01-1.4zM4 10c0-3.31 2.69-6 6-6s6 2.69 6 6-2.69 6-6 6-6-2.69-6-6z"/>
      </svg>
      <input type="text" id="searchInput" class="search-bar" placeholder="T√¨m ki·∫øm t√™n, s·ªë ƒëi·ªán tho·∫°i..." />
    </div>
  </header>

  <ul id="employee-list">
    </ul>

  <div style="text-align:center; color:#8E8E93; margin-top:40px; font-size:14px;">
    ƒêang hi·ªÉn th·ªã: <span id="current-branch-label">...</span>
  </div>

  <button id="fab" onclick="openNewForm()">
    <svg viewBox="0 0 24 24">
      <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
    </svg>
  </button>

  <div id="form-overlay" onclick="closeForm()"></div>
  <div id="slide-form">
    <div class="form-header">
      <button class="btn-text btn-cancel" type="button" onclick="closeForm()">H·ªßy</button>
      <div class="form-title">Th√™m nh√¢n vi√™n</div>
      <button class="btn-text btn-save" type="button" onclick="submitForm(false)">L∆∞u</button>
    </div>

    <div class="form-content">
      <form id="employeeForm">
        
        <div class="form-group">
          <div class="field-row">
            <label for="branch">Chi nh√°nh</label>
            <select id="branch" required>
              <option value="cherrypet">CherryPet</option>
              <option value="amthucbuonme">·∫®m th·ª±c Bu√¥n M√™</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <div class="field-row">
            <label for="fullname">H·ªç v√† t√™n</label>
            <input id="fullname" type="text" placeholder="Nguy·ªÖn VƒÉn A" required />
          </div>
          <div class="field-row">
            <label for="phone">S·ªë ƒëi·ªán tho·∫°i</label>
            <input id="phone" type="tel" placeholder="09xxxxxxxx" required />
          </div>
          
          <div class="field-row">
            <label for="birthDay">Ng√†y/Th√°ng/NƒÉm sinh</label>
            <div style="display: flex; gap: 8px; padding: 4px 0;">
              <select id="birthDay" style="flex: 1; border: none; font-size: 17px; font-family: var(--ios-font); outline: none; background: transparent; padding: 0;" required>
              </select>
              <select id="birthMonth" style="flex: 1; border: none; font-size: 17px; font-family: var(--ios-font); outline: none; background: transparent; padding: 0;" required>
              </select>
              <select id="birthYear" style="flex: 1; border: none; font-size: 17px; font-family: var(--ios-font); outline: none; background: transparent; padding: 0;" required>
              </select>
            </div>
          </div>
          <div class="field-row">
            <label for="startMonth">Th·ªùi gian b·∫Øt ƒë·∫ßu l√†m</label>
            <div style="display: flex; gap: 10px; padding: 4px 0;">
              <select id="startMonth" style="flex: 1; border: none; font-size: 17px; font-family: var(--ios-font); outline: none; background: transparent; padding: 0;" required>
              </select>
              <select id="startYear" style="flex: 1; border: none; font-size: 17px; font-family: var(--ios-font); outline: none; background: transparent; padding: 0;" required>
              </select>
            </div>
          </div>
        </div>

        <div class="form-group">
          <div class="field-row">
            <label for="schedule">Ca l√†m vi·ªác</label>
            <input id="schedule" type="text" placeholder="S√°ng / Chi·ªÅu / Full" required />
          </div>
          <div class="field-row">
            <label for="note">Ghi ch√∫ (V·ªã tr√≠)</label>
            <textarea id="note" rows="3" placeholder="V√≠ d·ª•: Thu ng√¢n"></textarea>
          </div>
        </div>
        
        <input type="hidden" id="employeeKey" value="" />
      </form>
    </div>
  </div>
  
  <div id="edit-modal" onclick="if(event.target.id === 'edit-modal') closeEditForm()">
      <div id="edit-form-card">
          <div class="edit-header">
              <button class="btn-text btn-cancel" type="button" onclick="closeEditForm()">H·ªßy</button>
              <div id="edit-form-title" class="form-title">Chi ti·∫øt nh√¢n vi√™n</div>
              <button class="btn-text btn-save" type="button" onclick="submitForm(true)">C·∫≠p nh·∫≠t</button>
          </div>
          
          <div class="edit-form-content">
              <form id="employeeEditForm">
                
                <div class="form-group">
                  <div class="field-row">
                    <label for="edit_branch">Chi nh√°nh</label>
                    <select id="edit_branch" required>
                      <option value="cherrypet">CherryPet</option>
                      <option value="amthucbuonme">·∫®m th·ª±c Bu√¥n M√™</option>
                    </select>
                  </div>
                </div>

                <div class="form-group">
                  <div class="field-row">
                    <label for="edit_fullname">H·ªç v√† t√™n</label>
                    <input id="edit_fullname" type="text" placeholder="Nguy·ªÖn VƒÉn A" required />
                  </div>
                  <div class="field-row">
                    <label for="edit_phone">S·ªë ƒëi·ªán tho·∫°i</label>
                    <input id="edit_phone" type="tel" placeholder="09xxxxxxxx" required />
                  </div>
                  
                  <div class="field-row">
                    <label for="edit_birthDay">Ng√†y/Th√°ng/NƒÉm sinh</label>
                    <div style="display: flex; gap: 8px; padding: 4px 0;">
                      <select id="edit_birthDay" style="flex: 1; border: none; font-size: 17px; font-family: var(--ios-font); outline: none; background: transparent; padding: 0;" required>
                      </select>
                      <select id="edit_birthMonth" style="flex: 1; border: none; font-size: 17px; font-family: var(--ios-font); outline: none; background: transparent; padding: 0;" required>
                      </select>
                      <select id="edit_birthYear" style="flex: 1; border: none; font-size: 17px; font-family: var(--ios-font); outline: none; background: transparent; padding: 0;" required>
                      </select>
                    </div>
                  </div>
                  <div class="field-row">
                    <label for="edit_startMonth">Th·ªùi gian b·∫Øt ƒë·∫ßu l√†m</label>
                    <div style="display: flex; gap: 10px; padding: 4px 0;">
                      <select id="edit_startMonth" style="flex: 1; border: none; font-size: 17px; font-family: var(--ios-font); outline: none; background: transparent; padding: 0;" required>
                      </select>
                      <select id="edit_startYear" style="flex: 1; border: none; font-size: 17px; font-family: var(--ios-font); outline: none; background: transparent; padding: 0;" required>
                      </select>
                    </div>
                  </div>
                </div>

                <div class="form-group">
                  <div class="field-row">
                    <label for="edit_schedule">Ca l√†m vi·ªác</label>
                    <input id="edit_schedule" type="text" placeholder="S√°ng / Chi·ªÅu / Full" required />
                  </div>
                  <div class="field-row">
                    <label for="edit_note">Ghi ch√∫ (V·ªã tr√≠)</label>
                    <textarea id="edit_note" rows="3" placeholder="V√≠ d·ª•: Thu ng√¢n"></textarea>
                  </div>
                </div>
                
                <input type="hidden" id="edit_employeeKey" value="" />
              </form>
              
              <div class="delete-button-container">
                  <button class="btn-full-red" type="button" onclick="deleteEmployee()">X√≥a nh√¢n vi√™n</button>
              </div>
          </div>
      </div>
  </div>

  <div id="toast" class="toast">Th√†nh c√¥ng</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, push, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // 1. Firebase Config (Gi·ªØ nguy√™n)
    const firebaseConfig = {
      apiKey: "AIzaSyBNB1acbPtKox8eTjth3FtWuDOLhueRIys",
      authDomain: "dogs-be72b.firebaseapp.com",
      databaseURL: "https://dogs-be72b-default-rtdb.firebaseio.com",
      projectId: "dogs-be72b",
      storageBucket: "dogs-be72b.firebase-storage.app",
      messagingSenderId: "1003873040746",
      appId: "1:1003873040746:web:607f4ff587afc430d3cd13",
      measurementId: "G-Y72BF1RQ2C"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const employeesRef = ref(db, 'employees');

    // 2. Global State
    let currentBranchFilter = ''; 
    let allData = []; 
    
    // START: H√ÄM KH·ªûI T·∫†O DROPDOWN THU·∫¶N VI·ªÜT (Cho C·∫£ Ng√†y sinh v√† Ng√†y l√†m)
    
    // T·∫°o √¥ ch·ªçn Ng√†y
    function createDayOptions(selectId) {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="" disabled selected>Ng√†y</option>';
        for (let i = 1; i <= 31; i++) {
            const dayValue = String(i).padStart(2, '0');
            select.innerHTML += `<option value="${dayValue}">Ng√†y ${i}</option>`;
        }
    }

    // T·∫°o √¥ ch·ªçn Th√°ng
    function createMonthOptions(selectId) {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="" disabled selected>Th√°ng</option>';
        for (let i = 1; i <= 12; i++) {
            const monthValue = String(i).padStart(2, '0');
            select.innerHTML += `<option value="${monthValue}">Th√°ng ${i}</option>`;
        }
    }

    // T·∫°o √¥ ch·ªçn NƒÉm
    function createYearOptions(selectId, startOffset, endOffset) {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="" disabled selected>NƒÉm</option>';
        const currentYear = new Date().getFullYear();
        // Hi·ªÉn th·ªã nƒÉm trong ph·∫°m vi
        for (let y = currentYear - startOffset; y <= currentYear + endOffset; y++) {
             // ƒê·∫£m b·∫£o nƒÉm sinh l√πi v·ªÅ 80 nƒÉm, nƒÉm b·∫Øt ƒë·∫ßu l√†m l√πi v·ªÅ 30 nƒÉm
             if (selectId.includes('birth') && y >= currentYear - 80) { 
                 select.innerHTML += `<option value="${y}">${y}</option>`;
             } else if (selectId.includes('start') && y >= currentYear - 30) {
                 select.innerHTML += `<option value="${y}">${y}</option>`;
             }
        }
        // ƒê·∫∑c bi·ªát: S·∫Øp x·∫øp nƒÉm theo th·ª© t·ª± gi·∫£m d·∫ßn cho d·ªÖ ch·ªçn
        const options = Array.from(select.options).slice(1).sort((a, b) => b.value - a.value);
        select.innerHTML = '<option value="" disabled selected>NƒÉm</option>' + options.map(opt => opt.outerHTML).join('');
    }
    
    function setupDateFields() {
        // Ng√†y/Th√°ng/NƒÉm sinh (80 nƒÉm tr∆∞·ªõc - hi·ªán t·∫°i)
        createDayOptions('birthDay');
        createMonthOptions('birthMonth');
        createYearOptions('birthYear', 80, 0); // L√πi 80 nƒÉm
        
        createDayOptions('edit_birthDay');
        createMonthOptions('edit_birthMonth');
        createYearOptions('edit_birthYear', 80, 0); // L√πi 80 nƒÉm

        // Th√°ng/NƒÉm b·∫Øt ƒë·∫ßu l√†m (30 nƒÉm tr∆∞·ªõc - hi·ªán t·∫°i)
        createMonthOptions('startMonth');
        createYearOptions('startYear', 30, 0); // L√πi 30 nƒÉm
        
        createMonthOptions('edit_startMonth');
        createYearOptions('edit_startYear', 30, 0); // L√πi 30 nƒÉm
    }
    // END: H√ÄM KH·ªûI T·∫†O DROPDOWN THU·∫¶N VI·ªÜT

    // 3. UI Helper Functions
    window.selectBranch = (branch) => {
      currentBranchFilter = branch;
      document.getElementById('branch-popup').classList.add('hidden');
      document.getElementById('current-branch-label').textContent = 
        branch === 'cherrypet' ? 'CherryPet' : '·∫®m th·ª±c Bu√¥n M√™';
      
      document.getElementById('branch').value = branch;
      
      renderList();
    };
    
    // ADDED: H√†m hi·ªÉn th·ªã l·∫°i m√†n h√¨nh ch·ªçn chi nh√°nh
    window.showBranchSelection = () => {
        currentBranchFilter = '';
        document.getElementById('branch-popup').classList.remove('hidden');
        document.getElementById('employee-list').innerHTML = ''; // X√≥a danh s√°ch hi·ªán t·∫°i
        document.getElementById('current-branch-label').textContent = '...';
    };


    window.openNewForm = () => { 
      document.getElementById('slide-form').querySelector('.form-title').textContent = 'Th√™m nh√¢n vi√™n';
      document.getElementById('employeeKey').value = ''; 
      document.getElementById('employeeForm').reset(); // Reset form khi m·ªü form th√™m m·ªõi
      setupDateFields(); // Kh·ªüi t·∫°o l·∫°i dropdown th√°ng/nƒÉm
      document.body.classList.add('form-active');
      if(currentBranchFilter) document.getElementById('branch').value = currentBranchFilter;
    };

    window.closeForm = () => {
      document.body.classList.remove('form-active');
      document.getElementById('employeeForm').reset();
      if(currentBranchFilter) document.getElementById('branch').value = currentBranchFilter;
    };
    
    window.openEditForm = (key) => {
        const employee = allData.find(emp => emp.key === key);
        if (!employee) return;
        
        document.getElementById('edit_employeeKey').value = key;
        document.getElementById('edit_fullname').value = employee.fullname || '';
        document.getElementById('edit_phone').value = employee.phone || '';
        document.getElementById('edit_schedule').value = employee.schedule || '';
        document.getElementById('edit_note').value = employee.note || '';
        document.getElementById('edit_branch').value = employee.branch || 'cherrypet';
        
        // Kh·ªüi t·∫°o v√† thi·∫øt l·∫≠p gi√° tr·ªã cho dropdowns
        setupDateFields(); 

        // Thi·∫øt l·∫≠p gi√° tr·ªã cho Ng√†y sinh (birthDate: YYYY-MM-DD)
        const birthDate = employee.birthDate || ''; 
        if (birthDate) {
            const [year, month, day] = birthDate.split('-');
            document.getElementById('edit_birthDay').value = day;
            document.getElementById('edit_birthMonth').value = month;
            document.getElementById('edit_birthYear').value = year;
        }

        // Thi·∫øt l·∫≠p gi√° tr·ªã cho Ng√†y b·∫Øt ƒë·∫ßu l√†m (startDate: YYYY-MM)
        const startDate = employee.startDate || ''; 
        if (startDate) {
            const [year, month] = startDate.split('-');
            document.getElementById('edit_startYear').value = year;
            document.getElementById('edit_startMonth').value = month;
        }

        document.getElementById('edit-form-title').textContent = `Chi ti·∫øt: ${employee.fullname}`;
        document.getElementById('edit-modal').classList.add('active');
    };
    
    window.closeEditForm = () => {
        document.getElementById('edit-modal').classList.remove('active');
        document.getElementById('employeeEditForm').reset();
    };


    function showToast(msg, type='success') {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = 'toast ' + type;
      t.style.display = 'block';
      setTimeout(() => { t.style.display = 'none'; }, 3000);
    }

    function getAvatarColor(name) {
      if (!name) return '#C7CEEA';
      const colors = ['#FF9AA2', '#FFB7B2', '#FFDAC1', '#E2F0CB', '#B5EAD7', '#C7CEEA', '#90C2E7'];
      let hash = 0;
      for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
      return colors[Math.abs(hash) % colors.length];
    }

    function getInitials(name) {
      if(!name) return '?';
      const parts = name.trim().split(' ');
      if(parts.length === 1) return parts[0][0].toUpperCase();
      return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }
    
    /**
     * H√†m t√≠nh s·ªë th√°ng l√†m vi·ªác
     * @param {string} dateString D·ªØ li·ªáu th√°ng/nƒÉm ·ªü ƒë·ªãnh d·∫°ng YYYY-MM
     * @returns {string} S·ªë th√°ng ƒë√£ l√†m (v√≠ d·ª•: "12 th√°ng")
     */
    function calculateMonthsWorked(dateString) {
        if (!dateString) return '';
        
        try {
            const [year, month] = dateString.split('-').map(Number);
            
            // Ng√†y b·∫Øt ƒë·∫ßu l√†m vi·ªác (1st c·ªßa th√°ng ƒë∆∞·ª£c ch·ªçn)
            const startDate = new Date(year, month - 1, 1); 
            const now = new Date();
            
            // S·ªë th√°ng ch√™nh l·ªách
            let diffMonths = (now.getFullYear() - startDate.getFullYear()) * 12;
            diffMonths += now.getMonth() - startDate.getMonth();
            
            if (diffMonths <= 0) return '0 th√°ng';

            const years = Math.floor(diffMonths / 12);
            const months = diffMonths % 12;
            
            let result = '';
            if (years > 0) result += `${years} nƒÉm `;
            if (months > 0) result += `${months} th√°ng`;
            
            return result.trim() || 'D∆∞·ªõi 1 th√°ng';
            
        } catch (e) {
            console.error("L·ªói t√≠nh to√°n s·ªë th√°ng l√†m vi·ªác:", e);
            return 'Kh√¥ng x√°c ƒë·ªãnh';
        }
    }


    // 4. Render Logic (Cards)
    function renderList() {
      const list = document.getElementById('employee-list');
      const search = document.getElementById('searchInput').value.toLowerCase();
      list.innerHTML = '';

      if (!currentBranchFilter) return; 

      const filtered = allData.filter(emp => {
        const matchesBranch = emp.branch === currentBranchFilter;
        const matchesSearch = (emp.fullname && emp.fullname.toLowerCase().includes(search)) || 
                              (emp.phone && emp.phone.includes(search));
        
        return matchesBranch && matchesSearch;
      });

      if (filtered.length === 0) {
        list.innerHTML = `<li style="text-align:center; padding:20px; color:#8E8E93">Kh√¥ng c√≥ nh√¢n vi√™n n√†o.</li>`;
        return;
      }

      filtered.forEach((emp, index) => {
        const li = document.createElement('li');
        li.className = 'emp-card';
        li.setAttribute('onclick', `openEditForm('${emp.key}')`); 
        li.style.animationDelay = `${index * 0.05}s`;

        const initials = getInitials(emp.fullname);
        const color = getAvatarColor(emp.fullname || '');
        
        const branchBadge = emp.branch === 'cherrypet' ? 'Cherry' : 'BMT';
        
        // X·ª≠ l√Ω Ng√†y sinh (birthDate: YYYY-MM-DD)
        let displayDOB = 'Ch∆∞a nh·∫≠p';
        if (emp.birthDate) {
            const parts = emp.birthDate.split('-');
            // ƒê·ªãnh d·∫°ng t·ª´ YYYY-MM-DD sang DD/MM/YYYY
            if (parts.length === 3) {
                displayDOB = `${parts[2]}/${parts[1]}/${parts[0]}`;
            } else {
                displayDOB = emp.birthDate; 
            }
        } 

        // ƒê·ªãnh d·∫°ng l·∫°i ng√†y b·∫Øt ƒë·∫ßu l√†m vi·ªác (MM/YYYY) v√† t√≠nh s·ªë th√°ng
        const formattedStartDate = emp.startDate ? emp.startDate.split('-').reverse().join('/') : 'Ch∆∞a nh·∫≠p';
        const monthsWorked = emp.startDate ? calculateMonthsWorked(emp.startDate) : 'Ch∆∞a r√µ';

        li.innerHTML = `
          <div class="avatar" style="background-color: ${color}">
            ${initials}
          </div>
          <div class="info">
            <h3>${escapeHtml(emp.fullname)}</h3>
            <p>üìû ${escapeHtml(emp.phone || 'Ch∆∞a c√≥ SƒêT')} ‚Ä¢ NS: ${displayDOB}</p>
            <p>üóìÔ∏è ${escapeHtml(emp.schedule)} | **V√†o l√†m:** ${formattedStartDate} (${monthsWorked})</p>
            ${emp.note ? `<p style="font-style:italic; color:#007AFF; margin-top:2px">${escapeHtml(emp.note)}</p>` : ''}
          </div>
          <div class="badge">${branchBadge}</div>
        `;
        list.appendChild(li);
      });
    }

    // 5. Submit Form Logic (S·ª≠ d·ª•ng cho c·∫£ Th√™m m·ªõi v√† C·∫≠p nh·∫≠t)
    window.submitForm = async (isEditMode) => {
      let data = {};
      let key = '';
      let form;
      
      let birthDateValue = '';
      let startDateValue = '';

      if (isEditMode) {
        form = document.getElementById('employeeEditForm');
        key = document.getElementById('edit_employeeKey').value;
        if (!form.checkValidity() || !key) { form.reportValidity(); return; }
        
        // L·∫•y v√† k·∫øt h·ª£p Ng√†y/Th√°ng/NƒÉm sinh
        const editDay = document.getElementById('edit_birthDay').value.trim();
        const editMonth = document.getElementById('edit_birthMonth').value.trim();
        const editYear = document.getElementById('edit_birthYear').value.trim();
        birthDateValue = editYear && editMonth && editDay ? `${editYear}-${editMonth}-${editDay}` : '';

        // L·∫•y v√† k·∫øt h·ª£p Th√°ng/NƒÉm t·ª´ dropdown (Start Date)
        const editStartMonth = document.getElementById('edit_startMonth').value.trim();
        const editStartYear = document.getElementById('edit_startYear').value.trim();
        startDateValue = editStartYear && editStartMonth ? `${editStartYear}-${editStartMonth}` : '';
        
        data = {
          branch: document.getElementById('edit_branch').value,
          fullname: document.getElementById('edit_fullname').value.trim(),
          phone: document.getElementById('edit_phone').value.trim(),
          birthDate: birthDateValue, // S·ª¨ D·ª§NG GI√Å TR·ªä K·∫æT H·ª¢P
          schedule: document.getElementById('edit_schedule').value.trim(),
          note: document.getElementById('edit_note').value.trim(),
          startDate: startDateValue, 
        };
      } else {
        form = document.getElementById('employeeForm');
        if (!form.checkValidity()) { form.reportValidity(); return; }
        
        // L·∫•y v√† k·∫øt h·ª£p Ng√†y/Th√°ng/NƒÉm sinh
        const newDay = document.getElementById('birthDay').value.trim();
        const newMonth = document.getElementById('birthMonth').value.trim();
        const newYear = document.getElementById('birthYear').value.trim();
        birthDateValue = newYear && newMonth && newDay ? `${newYear}-${newMonth}-${newDay}` : '';
        
        // L·∫•y v√† k·∫øt h·ª£p Th√°ng/NƒÉm t·ª´ dropdown (Start Date)
        const newStartMonth = document.getElementById('startMonth').value.trim();
        const newStartYear = document.getElementById('startYear').value.trim();
        startDateValue = newStartYear && newStartMonth ? `${newStartYear}-${newStartMonth}` : '';
        
        data = {
          branch: document.getElementById('branch').value,
          fullname: document.getElementById('fullname').value.trim(),
          phone: document.getElementById('phone').value.trim(),
          birthDate: birthDateValue, // S·ª¨ D·ª§NG GI√Å TR·ªä K·∫æT H·ª¢P
          schedule: document.getElementById('schedule').value.trim(),
          note: document.getElementById('note').value.trim(),
          startDate: startDateValue, 
          createdAt: Date.now()
        };
      }

      try {
        if (isEditMode) {
          const empRef = ref(db, `employees/${key}`);
          await update(empRef, data);
          showToast('C·∫≠p nh·∫≠t th√†nh c√¥ng ‚úÖ');
          closeEditForm();
        } else {
          const newRef = push(employeesRef);
          await set(newRef, data);
          showToast('ƒê√£ th√™m nh√¢n vi√™n ‚úÖ');
          closeForm();
        }
      } catch (err) {
        console.error(err);
        showToast('L·ªói l∆∞u/c·∫≠p nh·∫≠t d·ªØ li·ªáu', 'error');
      }
    };
    
    // 6. Delete Logic
    window.deleteEmployee = async () => {
        const key = document.getElementById('edit_employeeKey').value;
        if (!key) return;

        if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a nh√¢n vi√™n n√†y kh√¥ng?")) {
            try {
                const empRef = ref(db, `employees/${key}`);
                await remove(empRef);
                showToast('ƒê√£ x√≥a nh√¢n vi√™n üóëÔ∏è');
                closeEditForm();
            } catch (err) {
                console.error(err);
                showToast('L·ªói x√≥a d·ªØ li·ªáu', 'error');
            }
        }
    }

    // 7. Listeners
    document.getElementById('searchInput').addEventListener('input', renderList);

    // Firebase Listener
    onValue(employeesRef, (snapshot) => {
      const val = snapshot.val() || {};
      allData = Object.keys(val).map(key => ({
          key: key, 
          ...val[key]
      })).reverse();

      renderList();
    });

    // Kh·ªüi t·∫°o c√°c dropdown khi t·∫£i trang
    setupDateFields();

    // Security Helper
    function escapeHtml(text) {
      if (!text) return "";
      return String(text).replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
    }
  </script>
</body>
</html>
